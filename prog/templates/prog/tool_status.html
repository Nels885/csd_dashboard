{% extends 'format/datatables_format.html' %}

{% load static i18n %}

{% block card_header %}

    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" role="tablist">

            {% include 'prog/tab_select.html' with select='tools-status' %}

        </ul>
    </div>

{% endblock %}


{% block table_content %}

    <button class="add-tool btn btn-sm btn-primary mb-3"
            {% if not perms.prog.add_toolstatus %}disabled{% endif %}>
        <i class="fas fa-plus-square text-white-50"></i> Ajout Outil
    </button>

    <table class="table table-striped" style="width: 100%;">
        <thead class="thead-dark text-uppercase">
            <tr>
                <th></th>
                <th class="col-1">Nom</th>
                <th class="col-2">Commentaire</th>
                <th class="col-1 text-nowrap">NÂ° Xelon</th>
                <th class="col-1">Status</th>
                <th class="col-1 text-nowrap">Nb de prog</th>
                <th class="col-1 text-nowrap">Hostname</th>
                <th class="col-1">Logiciel</th>
                <th class="col-1 text-nowrap">Type Produit</th>
                <th class="col-1">Version</th>
                <th class=""></th>
            </tr>
        </thead>
        <tbody>
            {% for obj in object_list %}
            <tr>
                <td class="text-nowrap" style="width: 60px;">
                    {% if perms.prog.change_toolstatus %}
                        <a href="#" title="Modif. info outil" data-form-url="{% url 'prog:tool_update' obj.pk %}" class="bs-large-modal btn btn-success btn-circle btn-sm"><i class="fas fa-edit"></i></a>
                        {% if perms.prog.delete_toolstatus %}
                            <button data-form-url="{% url 'prog:tool_delete' obj.pk %}" title="Suppression" class="bs-modal btn btn-danger btn-circle btn-sm">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        {% endif %}
                        <span id="tool{{ obj.id }}-rb">
                            <button class="btn btn-dark btn-circle btn-sm" disabled><i class="fas fa-rotate"></i></button>
                        </span>
                        <span id="tool{{ obj.id }}-stp">
                            <button class="btn btn-dark btn-circle btn-sm" disabled><i class="fas fa-power-off"></i></button>
                        </span>
                    {% else %}
                        <button class="btn btn-dark btn-circle btn-sm" disabled><i class="fas fa-edit"></i></button>
                        <button class="btn btn-dark btn-circle btn-sm" disabled><i class="fas fa-rotate"></i></button>
                        <button class="btn btn-dark btn-circle btn-sm" disabled><i class="fas fa-power-off"></i></button>
                    {% endif %}

                </td>
                <td class="font-weight-bold text-nowrap">{{ obj.name }}</td>
                <td>{{ obj.comment }}</td>
                <td class="font-weight-bold" id="tool{{ obj.id }}-x"></td>
                <td class="font-weight-bold text-nowrap" id="tool{{ obj.id }}">Hors ligne</td>
                <td class="font-weight-bold" id="tool{{ obj.id }}-c"></td>
                <td class="font-weight-bold">{{ obj.hostname|upper }}</td>
                <td class="font-weight-bold">{{ obj.firmware }}</td>
                <td class="font-weight-bold" id="tool{{ obj.id }}-d"></td>
                <td class="font-weight-bold" id="tool{{ obj.id }}-v"></td>
                <td id="tool{{ obj.id }}-btn">
                    <button class="btn btn-block btn-secondary" disabled>Webapp</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

{% endblock %}

{% block extrascripts %}

    <script type="text/javascript" src="{% static 'prog/js/tools.js' %}"></script>
    <script type="text/javascript">
        let obj_list = [
            {% for obj in object_list %}
                "{{ obj.id }}"{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        function toolStop(pk){
            let url = "{% url 'prog:ajax_tool_system' pk=0 %}".replace('0', pk);
            toolSystem(url, "stop");
        }

        function toolRestart(pk){
            let url = "{% url 'prog:ajax_tool_system' pk=0 %}".replace('0', pk);
            toolSystem(url, "restart");
        }

        function getToolInfo() {
            for (let i in obj_list) {
                let pk = obj_list[i];
                $.ajax({
                    method: "get",
                    url: "{% url 'prog:ajax_tool_status' pk=0 %}".replace('0', pk),
                    success: function(data) {
                        toolChange(data, pk);
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });
            }
        }

        getToolInfo();
        setInterval(getToolInfo, 10000);
    </script>

{% endblock %}